<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleTv Cast Receiver</title>
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <!-- Cast Debug Logger - Shows logs on TV screen -->
    <script src="//www.gstatic.com/cast/sdk/libs/devtools/debug_layer/caf_receiver_logger.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 100%);
            overflow: hidden;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        #splash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #fff;
            transition: opacity 0.5s ease-out;
        }
        
        #splash.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .logo-container {
            margin-bottom: 40px;
            animation: fadeInScale 1s ease-out;
        }
        
        .app-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            margin: 0 auto 20px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
        }
        
        #splash h1 {
            font-size: 56px;
            font-weight: 700;
            margin: 0 0 16px 0;
            letter-spacing: -1px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }
        
        #splash p {
            font-size: 24px;
            opacity: 0.8;
            margin: 0;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }
        
        .status {
            margin-top: 40px;
            font-size: 18px;
            opacity: 0.6;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
        }
        
        /* Media player styles - shown when content is playing */
        cast-media-player {
            --theme-hue: 250;
            --progress-color: rgba(102, 126, 234, 0.9);
            --splash-image: none;
        }
    </style>
</head>
<body>
    <div id="splash">
        <div class="logo-container">
            <div class="app-icon">üì∫</div>
            <h1>SimpleTv</h1>
            <p>Premium IPTV Experience</p>
            <p style="color: #00ff00; font-size: 32px; font-weight: bold; margin-top: 20px;">üî¥ RECEIVER v8 - REDIRECT RESOLVER üî¥</p>
        </div>
        <div class="status">Ready to Cast...</div>
        <div id="debug-log" style="position: absolute; bottom: 20px; left: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; font-family: monospace; font-size: 18px; max-height: 300px; overflow-y: auto; color: #0f0;"></div>
    </div>

    <script>
        // RECEIVER VERSION - Update this when you make changes
        const RECEIVER_VERSION = 8;
        
        // IMMEDIATE DEBUG - Show on screen BEFORE Cast framework loads
        function debugLog(msg) {
            const debugDiv = document.getElementById('debug-log');
            if (debugDiv) {
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `<div>[${timestamp}] ${msg}</div>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
            console.log('[Receiver] ' + msg);
        }
        
        debugLog('========================================');
        debugLog('üöÄ SimpleTv Receiver Starting...');
        debugLog('üì¶ RECEIVER VERSION: ' + RECEIVER_VERSION);
        debugLog('üìÖ Load time: ' + new Date().toISOString());
        debugLog('üåê URL: ' + window.location.href);
        debugLog('========================================');
        
        // Initialize Cast Debug Logger - shows logs on TV screen
        const castDebugLogger = cast.debug.CastDebugLogger.getInstance();
        const LOG_TAG = 'SimpleTv';
        
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        
        debugLog('‚úÖ Cast framework loaded');
        debugLog('‚úÖ Context created');
        debugLog('‚úÖ Player manager initialized');
        
        // Enable debug logger when receiver is ready
        context.addEventListener(cast.framework.system.EventType.READY, () => {
            debugLog('üé¨ Receiver READY event fired');
            if (!castDebugLogger.debugOverlayElement_) {
                castDebugLogger.setEnabled(true);
                castDebugLogger.showDebugLogs(true);
                castDebugLogger.info(LOG_TAG, 'üöÄ Debug logger enabled - logs will show on TV');
                castDebugLogger.info(LOG_TAG, 'üìÖ Receiver started at: ' + new Date().toISOString());
                debugLog('‚úÖ Cast Debug Logger enabled');
            }
        });

        // Configure player with custom headers and CORS handling
        const playbackConfig = new cast.framework.PlaybackConfig();
        
        debugLog('‚öôÔ∏è Configuring playback...');
        castDebugLogger.info(LOG_TAG, '‚öôÔ∏è Configuring playback with custom headers...');
        
        // Enable all codecs for maximum compatibility
        playbackConfig.manifestRequestHandler = (request) => {
            debugLog('üì° Manifest request: ' + request.url.substring(0, 60));
            console.log('[Receiver] üì° ========== MANIFEST REQUEST ==========');
            console.log('[Receiver] URL:', request.url);
            castDebugLogger.info(LOG_TAG, 'üì° Manifest request: ' + request.url.substring(0, 80));
            
            // Add mobile User-Agent to ALL requests (including redirects)
            request.headers = request.headers || {};
            request.headers['User-Agent'] = 'ExoPlayer/2.18.1 (Linux;Android 13) ExoPlayerLib/2.18.1';
            request.headers['Accept'] = '*/*';
            request.headers['Connection'] = 'keep-alive';
            
            console.log('[Receiver] üîë Custom headers:', JSON.stringify(request.headers, null, 2));
            castDebugLogger.debug(LOG_TAG, 'üîë Added mobile User-Agent');
            
            console.log('[Receiver] =============================================');
            return request;
        };

        // Handle segment requests with custom headers
        playbackConfig.segmentRequestHandler = (request) => {
            console.log('[Receiver] üì¶ Segment request:', request.url.substring(0, 100));
            castDebugLogger.debug(LOG_TAG, 'üì¶ Segment: ' + request.url.substring(0, 60));
            
            // Add mobile User-Agent for segment requests (.ts files)
            request.headers = request.headers || {};
            request.headers['User-Agent'] = 'ExoPlayer/2.18.1 (Linux;Android 13) ExoPlayerLib/2.18.1';
            request.headers['Accept'] = '*/*';
            request.headers['Connection'] = 'keep-alive';
            
            return request;
        };
        
        // CRITICAL: Handle direct .ts stream URLs (not HLS)
        // For direct .ts URLs, we need special handling
        playbackConfig.licenseRequestHandler = (request) => {
            console.log('[Receiver] üîê License request (shouldn\'t happen for IPTV):', request.url);
            castDebugLogger.warn(LOG_TAG, 'üîê Unexpected license request');
            return request;
        };

        playerManager.setPlaybackConfig(playbackConfig);
        castDebugLogger.info(LOG_TAG, '‚úÖ Playback config set');

        // Intercept LOAD requests to log and add custom handling if needed
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            (loadRequestData) => {
                debugLog('===== LOAD REQUEST =====');
                console.log('[Receiver] ===== LOAD REQUEST =====');
                console.log('[Receiver] Full request:', JSON.stringify(loadRequestData, null, 2));
                castDebugLogger.info(LOG_TAG, 'üì• LOAD REQUEST RECEIVED');
                
                const media = loadRequestData.media;
                if (media && media.contentUrl) {
                    const originalUrl = media.contentUrl;
                    debugLog('üì° URL: ' + originalUrl.substring(0, 60));
                    console.log('[Receiver] üì° URL:', originalUrl);
                    castDebugLogger.info(LOG_TAG, 'üì° URL: ' + originalUrl.substring(0, 80));
                    
                    // Note: We don't resolve redirects here - the player will follow them
                    // Our manifestRequestHandler will add the proper headers to authenticate
                    castDebugLogger.info(LOG_TAG, 'üîÑ Will follow redirects with mobile UA');
                    
                    debugLog('üé¨ Type: ' + media.contentType);
                    debugLog('üìä Stream: ' + media.streamType);
                    
                    console.log('[Receiver] üì° Final URL:', media.contentUrl);
                    console.log('[Receiver] üé¨ Content Type:', media.contentType);
                    console.log('[Receiver] üìä Stream Type:', media.streamType);
                    
                    castDebugLogger.info(LOG_TAG, 'üì° Final URL: ' + media.contentUrl.substring(0, 80));
                    castDebugLogger.info(LOG_TAG, 'üé¨ Type: ' + media.contentType);
                    castDebugLogger.info(LOG_TAG, 'üìä Stream: ' + media.streamType);
                    
                    // Don't override content types - let the sender handle it
                    // The custom headers from manifestRequestHandler and segmentRequestHandler
                    // will handle IPTV authentication for all stream types
                    
                    const urlPath = media.contentUrl.toLowerCase();
                    if (urlPath.includes('.mp4')) {
                        console.log('[Receiver] üé• Detected: MP4 Video (VOD)');
                        castDebugLogger.debug(LOG_TAG, 'üé• MP4 Video detected');
                    } else if (urlPath.includes('.m3u8')) {
                        console.log('[Receiver] üì∫ Detected: HLS Stream (Live TV)');
                        castDebugLogger.debug(LOG_TAG, 'üì∫ HLS Stream detected');
                    } else if (urlPath.includes('.ts')) {
                        console.log('[Receiver] üì∫ Detected: TS Stream (Live TV)');
                        castDebugLogger.warn(LOG_TAG, 'üì∫ Direct .ts stream - may not work!');
                    } else if (urlPath.includes('.mkv')) {
                        console.log('[Receiver] üé¨ Detected: MKV Video');
                        castDebugLogger.debug(LOG_TAG, 'üé¨ MKV Video detected');
                    }
                    
                    console.log('[Receiver] ===== END REQUEST =====');
                }
                
                // Send receiver version back to sender app
                const customData = loadRequestData.customData || {};
                customData.receiverVersion = RECEIVER_VERSION;
                loadRequestData.customData = customData;
                
                debugLog('üì§ Sending receiver version: ' + RECEIVER_VERSION);
                
                // Return modified request with version info
                return loadRequestData;
            }
        );

        // Log player events with comprehensive error details
        playerManager.addEventListener(
            cast.framework.events.EventType.ERROR,
            (event) => {
                debugLog('‚ùå ERROR: ' + event.detailedErrorCode);
                debugLog('üí• Reason: ' + (event.reason || 'Unknown'));
                
                console.error('[Receiver] ‚ùå ========== ERROR OCCURRED ==========');
                console.error('[Receiver] Error event:', event);
                console.error('[Receiver] Error type:', event.type);
                console.error('[Receiver] Error detailedErrorCode:', event.detailedErrorCode);
                console.error('[Receiver] Error reason:', event.reason);
                
                castDebugLogger.error(LOG_TAG, '‚ùå ERROR: ' + event.detailedErrorCode);
                castDebugLogger.error(LOG_TAG, 'üí• Reason: ' + (event.reason || 'Unknown'));
                
                // Log the media info that failed
                const mediaInfo = playerManager.getMediaInformation();
                if (mediaInfo) {
                    debugLog('üîó Failed URL: ' + (mediaInfo.contentUrl || 'Unknown').substring(0, 50));
                    console.error('[Receiver] Failed media URL:', mediaInfo.contentUrl);
                    console.error('[Receiver] Failed media type:', mediaInfo.contentType);
                    console.error('[Receiver] Failed media streamType:', mediaInfo.streamType);
                    
                    castDebugLogger.error(LOG_TAG, 'üîó Failed URL: ' + (mediaInfo.contentUrl || 'Unknown').substring(0, 60));
                }
                
                console.error('[Receiver] Full error JSON:', JSON.stringify(event, null, 2));
                console.error('[Receiver] ========================================');
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,
            () => {
                console.log('[Receiver] ‚úÖ ========== PLAYER LOADED ==========');
                const mediaInfo = playerManager.getMediaInformation();
                if (mediaInfo) {
                    console.log('[Receiver] Loaded URL:', mediaInfo.contentUrl);
                    console.log('[Receiver] Content type:', mediaInfo.contentType);
                    console.log('[Receiver] Stream type:', mediaInfo.streamType);
                }
                const mediaStatus = playerManager.getPlayerState();
                console.log('[Receiver] Player state:', mediaStatus);
                console.log('[Receiver] =========================================');
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_LOADING,
            (event) => {
                debugLog('‚è≥ PLAYER LOADING...');
                console.log('[Receiver] ‚è≥ ========== PLAYER LOADING ==========');
                console.log('[Receiver] Loading event:', event);
                const mediaInfo = playerManager.getMediaInformation();
                if (mediaInfo) {
                    debugLog('üì∫ Loading: ' + mediaInfo.contentUrl.substring(0, 50));
                    console.log('[Receiver] Loading URL:', mediaInfo.contentUrl);
                    console.log('[Receiver] Content type:', mediaInfo.contentType);
                }
                console.log('[Receiver] =========================================');
                // Hide splash when media starts loading
                const splash = document.getElementById('splash');
                if (splash) {
                    splash.classList.add('hidden');
                }
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.BUFFERING,
            (event) => {
                console.log('[Receiver] üìä Buffering:', event.isBuffering ? 'STARTED' : 'ENDED');
                if (event.isBuffering) {
                    console.log('[Receiver] Stream is buffering...');
                } else {
                    console.log('[Receiver] ‚úÖ Buffering complete, should start playing');
                }
            }
        );

        // Show splash again when media ends or session becomes idle
        playerManager.addEventListener(
            cast.framework.events.EventType.MEDIA_FINISHED,
            () => {
                console.log('[Receiver] üèÅ Media finished');
                const splash = document.getElementById('splash');
                if (splash) {
                    splash.classList.remove('hidden');
                }
            }
        );

        // Listen for custom messages from the sender app
        context.addCustomMessageListener('urn:x-cast:com.simpletv.version', (event) => {
            debugLog('üì¨ Received version check message');
            console.log('[Receiver] üì¨ Version check message:', event.data);
            
            if (event.data && event.data.action === 'checkVersion') {
                // Send current version back
                const message = {
                    type: 'versionResponse',
                    receiverVersion: RECEIVER_VERSION,
                    timestamp: new Date().toISOString()
                };
                
                debugLog('üì§ Sending version: ' + RECEIVER_VERSION);
                context.sendCustomMessage('urn:x-cast:com.simpletv.version', event.senderId, message);
            } else if (event.data && event.data.action === 'reload') {
                debugLog('üîÑ Reload requested - reloading receiver...');
                console.log('[Receiver] üîÑ App requested reload to get latest version');
                
                // Show a message on TV before reloading
                const splash = document.getElementById('splash');
                if (splash) {
                    splash.classList.remove('hidden');
                    splash.querySelector('p:last-child').textContent = 'üîÑ Updating to latest version...';
                }
                
                // Reload after 2 seconds to show the message
                setTimeout(() => {
                    window.location.reload(true); // Force reload from server
                }, 2000);
            }
        });

        // Start the receiver
        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = false;
        options.maxInactivity = 3600; // 1 hour
        
        debugLog('========================================');
        debugLog('üé¨ Starting SimpleTv Cast Receiver...');
        console.log('[Receiver] ========================================');
        console.log('[Receiver] üé¨ Starting SimpleTv Cast Receiver...');
        console.log('[Receiver] ‚öôÔ∏è Options:', JSON.stringify(options, null, 2));
        console.log('[Receiver] ========================================');
        
        try {
            context.start(options);
            debugLog('‚úÖ Receiver started successfully!');
            debugLog('‚úÖ Ready to accept connections');
            console.log('[Receiver] ‚úÖ ========================================');
            console.log('[Receiver] ‚úÖ Receiver started successfully!');
            console.log('[Receiver] ‚úÖ Ready to accept connections');
            console.log('[Receiver] ‚úÖ ========================================');
        } catch (error) {
            debugLog('‚ùå FAILED TO START RECEIVER!');
            debugLog('‚ùå Error: ' + error);
            console.error('[Receiver] ‚ùå ========================================');
            console.error('[Receiver] ‚ùå FAILED TO START RECEIVER!');
            console.error('[Receiver] ‚ùå Error:', error);
            console.error('[Receiver] ‚ùå ========================================');
        }
    </script>
</body>
</html>
