<!DOCTYPE html>
<html>
<head>
  <title>SimpleTv Cast Receiver</title>
  <meta charset="utf-8">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
      overflow: hidden;
    }
    cast-media-player {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <cast-media-player></cast-media-player>
  
  <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <script>
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();
    
    console.log('[SimpleTv Receiver] üöÄ Initializing...');
    
    // Intercept LOAD requests to resolve HTTP redirects
    playerManager.setMessageInterceptor(
      cast.framework.messages.MessageType.LOAD,
      async (loadRequestData) => {
        console.log('[SimpleTv] üì° Load request received');
        console.log('[SimpleTv] üì∫ Original URL:', loadRequestData.media.contentId);
        
        const originalUrl = loadRequestData.media.contentId;
        
        try {
          // Fetch the URL to follow any HTTP 302 redirects
          // The browser will automatically follow redirects
          const response = await fetch(originalUrl, {
            method: 'HEAD',  // Use HEAD to avoid downloading content
            redirect: 'follow'  // Browser follows redirects automatically
          });
          
          // The final URL after all redirects
          const finalUrl = response.url;
          
          console.log('[SimpleTv] ‚úÖ Resolved URL:', finalUrl);
          console.log('[SimpleTv] üìä Status:', response.status);
          console.log('[SimpleTv] üéµ Content-Type:', response.headers.get('content-type'));
          
          // Update the media URL with the resolved URL
          if (finalUrl !== originalUrl) {
            console.log('[SimpleTv] üîÑ URL changed after redirect');
            loadRequestData.media.contentId = finalUrl;
          } else {
            console.log('[SimpleTv] ‚ÑπÔ∏è No redirect detected');
          }
          
        } catch (error) {
          console.error('[SimpleTv] ‚ùå Failed to resolve URL:', error);
          console.error('[SimpleTv] ‚ö†Ô∏è Will try playing original URL');
          // Continue with original URL if fetch fails
        }
        
        return loadRequestData;
      }
    );
    
    // Log playback events for debugging
    playerManager.addEventListener(
      cast.framework.events.EventType.ERROR,
      (event) => {
        console.error('[SimpleTv] ‚ùå Playback error:', event);
      }
    );
    
    playerManager.addEventListener(
      cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,
      () => {
        console.log('[SimpleTv] ‚úÖ Media loaded successfully');
      }
    );
    
    playerManager.addEventListener(
      cast.framework.events.EventType.PLAYING,
      () => {
        console.log('[SimpleTv] ‚ñ∂Ô∏è Playback started');
      }
    );
    
    // Configure receiver options
    const options = new cast.framework.CastReceiverOptions();
    options.disableIdleTimeout = false;
    options.maxInactivity = 3600; // 1 hour
    
    // Start the receiver
    context.start(options);
    console.log('[SimpleTv Receiver] ‚úÖ Started successfully');
  </script>
</body>
</html>
