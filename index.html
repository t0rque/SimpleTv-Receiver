<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleTv Cast Receiver</title>
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
        }
        
        #splash {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            font-family: 'Roboto', sans-serif;
        }
        
        #splash h1 {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        #splash p {
            font-size: 24px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="splash">
        <h1>📺 SimpleTv</h1>
        <p>Ready to Cast</p>
    </div>

    <script>
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();

        // Configure player with custom headers and CORS handling
        const playbackConfig = new cast.framework.PlaybackConfig();
        
        // Enable all codecs for maximum compatibility
        playbackConfig.manifestRequestHandler = (request) => {
            console.log('[Receiver] Manifest request:', request.url);
            
            // Add headers that might be needed by IPTV servers
            request.headers = request.headers || {};
            request.headers['User-Agent'] = 'Mozilla/5.0 (X11; Linux armv7l) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 CrKey/1.56.500000';
            request.headers['Accept'] = '*/*';
            request.headers['Origin'] = 'https://supremeiptv.app';
            
            return request;
        };

        // Handle segment requests with custom headers
        playbackConfig.segmentRequestHandler = (request) => {
            console.log('[Receiver] Segment request:', request.url);
            
            // Add headers for segment requests
            request.headers = request.headers || {};
            request.headers['User-Agent'] = 'Mozilla/5.0 (X11; Linux armv7l) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 CrKey/1.56.500000';
            request.headers['Accept'] = '*/*';
            
            return request;
        };

        playerManager.setPlaybackConfig(playbackConfig);

        // Intercept LOAD requests to modify media info if needed
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            (loadRequestData) => {
                console.log('[Receiver] Load request:', JSON.stringify(loadRequestData, null, 2));
                
                const media = loadRequestData.media;
                if (media && media.contentUrl) {
                    console.log('[Receiver] Loading:', media.contentUrl);
                    console.log('[Receiver] Content type:', media.contentType);
                    
                    // Remove query parameters for better extension detection
                    const urlPath = media.contentUrl.toLowerCase().split('?')[0];
                    
                    // For MP4 files, try standard video/mp4 first
                    if (urlPath.includes('.mp4')) {
                        // Try standard MP4 MIME type
                        media.contentType = 'video/mp4';
                        console.log('[Receiver] 🎥 Using video/mp4 for MP4 file');
                        
                        // Set stream type appropriately
                        if (!media.streamType) {
                            media.streamType = cast.framework.messages.StreamType.BUFFERED;
                        }
                    }
                    
                    // For MKV files
                    if (urlPath.endsWith('.mkv')) {
                        media.contentType = 'video/x-matroska';
                        console.log('[Receiver] Forcing MKV content type');
                    }
                }
                
                return loadRequestData;
            }
        );

        // Log player events
        playerManager.addEventListener(
            cast.framework.events.EventType.ERROR,
            (event) => {
                console.error('[Receiver] ❌ ERROR:', event);
                console.error('[Receiver] Error details:', JSON.stringify(event, null, 2));
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,
            () => {
                console.log('[Receiver] ✅ Player loaded successfully');
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_LOADING,
            (event) => {
                console.log('[Receiver] ⏳ Player loading...', event);
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.BUFFERING,
            (event) => {
                console.log('[Receiver] 📊 Buffering...', event.isBuffering);
            }
        );

        // Start the receiver
        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = false;
        options.maxInactivity = 3600; // 1 hour
        
        console.log('[Receiver] Starting SimpleTv Cast Receiver...');
        context.start(options);
        console.log('[Receiver] Receiver started successfully');
    </script>
</body>
</html>
